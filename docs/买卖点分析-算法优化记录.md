# 买卖点分析 - 算法优化记录

## 更新日期
2026-01-15

## 优化内容

### 1. MACD阈值修正（关键修复）

#### 问题
所有股票一年内都被判断为"震荡"，几乎没有触发买卖信号。

#### 原因分析
MACD的DIFF值阈值设置过大：
- 旧阈值：±0.5
- MACD DIFF = EMA12 - EMA26
- 实际DIFF值通常在±0.1到±0.3之间波动
- ±0.5是极端值，99%的情况都会被判断为"震荡"

#### 修复方案
```python
# 修改前
elif diff > 0.5:  # 太大！
    macd_position = MacdPosition.ABOVE
elif diff < -0.5:  # 太大！
    macd_position = MacdPosition.BELOW

# 修改后
elif diff > 0.05:  # 合理
    macd_position = MacdPosition.ABOVE
elif diff < -0.05:  # 合理
    macd_position = MacdPosition.BELOW
```

#### 影响
- 修复后，能够正常识别趋势（多头/空头）
- 震荡期占比从99%降低到合理范围（约30-40%）

---

### 2. 入场触发条件优化（灵活性提升）

#### 问题
大部分股票无法触发信号，只能触发顶背离/底背离退出信号。

#### 原因分析

**旧逻辑过于严格：**
```python
is_triggered = pattern_matched and volume_confirmed
# 必须同时满足：
# 1. 有特定的K线形态（6种看涨/6种看跌）
# 2. 成交量≥1.3倍MA5
```

问题：
1. K线形态本身出现频率低
2. 特定形态识别不够全面
3. 两个条件必须同时满足，过于苛刻
4. 成交量1.3倍阈值偏高

#### 修复方案

**新逻辑：三种触发模式，满足任一即可**

##### 模式1：严格模式
- 条件：有符合方向的K线形态 + 成交量≥1.3倍
- 适用：高质量信号
- 代码：
```python
if pattern_matched and volume_ratio >= 1.3:
    trigger_mode = 'strict'
```

##### 模式2：宽松模式（新增）
- 条件：有符合方向的K线形态 + 成交量≥1.1倍
- 适用：形态明显但成交量稍弱
- 代码：
```python
elif pattern_matched and volume_ratio >= 1.1:
    trigger_mode = 'loose'
```

##### 模式3：极度放量模式（新增）
- 条件：无特定形态 + 成交量≥1.5倍 + 价格符合趋势
- 适用：放量突破/放量下跌
- 价格趋势判断：
  - 做多：收盘价 > 开盘价（阳线）
  - 做空：收盘价 < 开盘价（阴线）
- 代码：
```python
elif not pattern_matched and volume_ratio >= 1.5 and price_trend_match:
    trigger_mode = 'volume_only'
```

#### 扩展的K线形态列表

**看涨形态（9种 ← 6种）：**
- 原有：吞没、启明星、锤子线、倒锤子、刺穿、三白兵
- 新增：穿刺线、看涨孕线、蜻蜓十字星

**看跌形态（8种 ← 6种）：**
- 原有：吞没、黄昏星、流星、上吊线、乌云盖顶、三黑鸦
- 新增：看跌孕线、墓碑十字星

#### 影响
- 信号覆盖率显著提升
- 保留了高质量信号（严格模式）
- 增加了中等质量信号（宽松模式）
- 捕获放量突破/下跌（纯放量模式）

---

### 3. 评分系统替代强度（新功能）

#### 变化
将模糊的"强/弱"信号改为明确的1-10分评分系统。

#### 评分规则

| 维度 | 最高分 | 得分条件 |
|-----|-------|---------|
| **市场状态** | 3分 | 置信度>0.7: +3分<br>置信度>0.5: +2分<br>其他: +1分 |
| **关键区域** | 2分 | 在关键支撑/阻力区: +2分<br>在一般关键区域: +1分<br>不在关键区域: +0分 |
| **成交量** | 3分 | ≥2.0倍MA5: +3分<br>≥1.5倍MA5: +2分<br>≥1.3倍MA5: +1分 |
| **K线形态** | 2分 | 强反转形态: +2分<br>一般形态: +1分 |
| **风险评估** | -3分 | 无风险: +0分<br>低风险: -1分<br>中风险: -2分<br>高风险: -3分 |

**总分范围：1-10分**
- 8-10分：强信号
- 6-7分：中等信号
- 4-5分：弱信号
- <4分：不生成信号

#### 优势
1. 评分透明，可追溯
2. 每个信号都有详细的得分明细
3. 方便回测和优化
4. 用户可以自行设置阈值

#### 信号结构

```python
{
    'score': 7,  # 总分
    'score_details': {
        'market_state': 3,
        'key_area': 2,
        'volume': 2,
        'pattern': 1,
        'risk': -1
    },
    'score_breakdown': [
        '市场状态强劲(置信度75%) +3分',
        '在关键支撑区 +2分',
        '成交量放大1.6倍(≥1.5) +2分',
        '一般形态(锤子线) +1分',
        '⚠️ 低风险(底背离) -1分'
    ]
}
```

---

## 修改的文件

### 1. `utils/trading_signal_analyzer.py`

**修改1：MACD阈值**
- 第376-380行：将±0.5改为±0.05

**修改2：入场触发逻辑**
- 第545-686行：完全重构`_step3_entry_trigger`方法
- 新增三种触发模式
- 扩展K线形态列表
- 添加价格趋势判断

**修改3：评分系统**
- 第711-1002行：重构`_generate_signal`方法
- 新增`_calculate_entry_signal_score`方法
- 替换strength为score

### 2. `enums/market_state.py`

**修改：**
- 第35行：更新MACD NEUTRAL的描述从"[-0.5~0.5]"到"[-0.05~0.05]"

---

## 效果对比

### 修复前
- 震荡期占比：~99%
- 多头天数：~0天
- 空头天数：~0天
- 生成信号：0个（只有退出信号）

### 修复后（预期）
- 震荡期占比：~30-40%
- 多头天数：~30-35%
- 空头天数：~30-35%
- 生成信号：显著增加
- 信号质量：多层次（严格/宽松/放量）

---

## 使用建议

### 1. 如何查看触发模式

```python
result = analyzer.analyze()
for signal in result['signals']:
    mode = signal['analysis']['entry_trigger']['trigger_mode']
    print(f"触发模式: {mode}")
    # 输出: strict / loose / volume_only
```

### 2. 如何查看评分明细

```python
for signal in result['signals']:
    print(f"总分: {signal['score']}")
    print(f"评分明细:")
    for reason in signal['score_breakdown']:
        print(f"  - {reason}")
```

### 3. 如何筛选高质量信号

```python
# 只看8分以上的强信号
strong_signals = [s for s in signals if s['score'] >= 8]

# 只看严格模式触发的信号
strict_signals = [s for s in signals
                  if s['analysis']['entry_trigger']['trigger_mode'] == 'strict']
```

---

## 后续优化方向

### 1. 参数可配置化
- MACD阈值（当前±0.05）
- 成交量倍数（当前1.1/1.3/1.5）
- 评分阈值（当前4分）

### 2. 动态阈值
- 根据股票的波动率调整MACD阈值
- 根据股票的成交量特性调整放量阈值

### 3. 机器学习优化
- 根据历史信号的盈亏情况优化评分权重
- 自动学习最优参数组合

---

## 版本历史

- **v1.4** (2026-01-15):
  - 修复MACD阈值问题
  - 优化入场触发条件
  - 引入评分系统

- **v1.3** (2026-01-13): 数据结构优化，K线标记
- **v1.2** (2026-01-13): 枚举优化
- **v1.1**: 无信号原因，预热天数优化
- **v1.0**: 初始版本
