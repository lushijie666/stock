# 买卖点分析 - 快速使用指南

## 新版本快速上手（v1.3）

### 一、基本使用

```python
from utils.trading_signal_analyzer import TradingSignalAnalyzer
from utils.trading_analysis_ui import render_trading_analysis_ui

# 1. 创建分析器（df是股票数据DataFrame）
analyzer = TradingSignalAnalyzer(df)

# 2. 执行分析
result = analyzer.analyze()

# 3. 获取3部分数据
signals = result['signals']              # 买卖信号列表
stats = result['statistics']             # 统计信息
daily_analysis = result['daily_analysis'] # 每日分析

# 4. 在UI中展示
render_trading_analysis_ui(signals, df, analyzer, stats, daily_analysis)
```

### 二、数据结构说明

#### signals - 买卖信号列表

包含真正触发的买卖信号：

```python
for signal in signals:
    print(f"日期: {signal['date']}")
    print(f"价格: {signal['price']}")
    print(f"类型: {signal['type'].text}")  # 做多/做空
    print(f"动作: {signal['action']}")      # ENTER_LONG/EXIT_LONG等
    print(f"原因: {signal['reason']}")      # 触发原因
    print("---")
```

#### statistics - 统计信息

了解整体分析情况：

```python
print(f"总共分析了 {stats['total_days']} 天")
print(f"其中震荡期 {stats['ranging_days']} 天")
print(f"多头趋势 {stats['long_days']} 天")
print(f"空头趋势 {stats['short_days']} 天")
print(f"生成信号 {stats['signal_days']} 个")

# 诊断为什么没有信号
if stats['signal_days'] == 0:
    print(f"有趋势但无形态: {stats['no_pattern_days']} 天")
    print(f"有形态但量不够: {stats['no_volume_days']} 天")
    print(f"被风险过滤: {stats['filtered_by_risk']} 天")
```

#### daily_analysis - 每日分析

查看任意一天的完整分析：

```python
# 查找特定日期
import pandas as pd

target_date = pd.Timestamp('2025-01-10')
day_info = next((d for d in daily_analysis if d['date'] == target_date), None)

if day_info:
    print(f"日期: {day_info['date']}")
    print(f"价格: {day_info['price']}")
    print(f"原因: {day_info['reason']}")
    print(f"是否有信号: {day_info['has_signal']}")

    # 查看4步分析详情
    print(f"市场方向: {day_info['step1_market_state']['direction'].text}")
    print(f"MACD位置: {day_info['step1_market_state']['macd_position'].text}")
    print(f"RSI状态: {day_info['step1_market_state']['rsi_state'].text}")
```

### 三、UI功能亮点

#### 1. K线图标记

自动在K线图上标记所有买卖信号：
- 买入信号：绿色▲
- 卖出信号：红色▼
- 鼠标悬停查看详情

```python
# UI会自动展示，也可以单独调用
from utils.trading_analysis_ui import render_kline_with_signals
render_kline_with_signals(df, signals)
```

#### 2. 统计信息展示

清晰显示：
- 总体统计（多少天震荡、多少天趋势）
- 信号数量和分布
- 无信号原因诊断

#### 3. 信号详情

每个信号都展开显示4步分析：
- ① 市场状态判定
- ② 关键区域识别
- ③ 入场触发验证
- ④ 风险过滤

#### 4. 逐日分析查询

选择任意日期，查看完整分析：
- 即使没有生成信号的日期也能查看
- 了解为什么没有信号
- 追踪市场状态变化

### 四、常见问题

#### Q1: 为什么没有生成信号？

查看统计信息的诊断：

```python
stats = result['statistics']

if stats['ranging_days'] > stats['total_days'] * 0.7:
    print("主要是震荡期，MACD和RSI方向不一致")

if stats['no_pattern_days'] > 0:
    print("有趋势但缺少关键K线形态")

if stats['no_volume_days'] > 0:
    print("有形态但成交量不足")

if stats['filtered_by_risk'] > 0:
    print("有信号但被风险过滤（背离）")
```

#### Q2: 如何查看具体某天为什么没有信号？

```python
# 从 daily_analysis 中查找
target_date = pd.Timestamp('2025-01-10')
day_info = next((d for d in daily_analysis if d['date'] == target_date), None)

if day_info:
    print(day_info['reason'])  # 直接查看原因
```

示例输出：
- `"震荡期：MACD0轴附近(-0.123) | RSI震荡区间(48.5)"`
- `"做多趋势，但未检测到有效K线形态"`
- `"做多趋势，有形态但成交量不足（1.15x）"`

#### Q3: 如何理解信号的原因？

每个信号的 `reason` 字段会详细说明：

```python
signal['reason']
# 示例：
# "MACD在0轴上方 | RSI=62.5（多头趋势） | 在关键支撑区：接近MA20 | 出现看涨吞没 | 成交量放大1.8倍"
```

包含信息：
- MACD位置
- RSI值和状态
- 是否在关键支撑/阻力区
- 检测到的K线形态
- 成交量倍数
- 风险提示（如果有）

#### Q4: 数据要求是什么？

```python
# 最少需要120天数据
if len(df) < 120:
    print("数据不足，需要至少120天")
elif len(df) < 200:
    print("数据可用但建议至少200天以获得更准确分析")
else:
    print("数据充足，可以进行高质量分析")
```

原因：
- MA60需要60天
- 前期高低点分析需要20天
- RSI背离检测需要10天
- 额外缓冲30天确保指标稳定

### 五、完整示例代码

```python
import pandas as pd
import streamlit as st
from utils.trading_signal_analyzer import TradingSignalAnalyzer
from utils.trading_analysis_ui import render_trading_analysis_ui

# 假设已经有了股票数据df
# df包含列：date, opening, close, highest, lowest, turnover_count等

# 1. 数据检查
if len(df) < 120:
    st.warning("数据不足，需要至少120天数据")
else:
    # 2. 创建分析器
    analyzer = TradingSignalAnalyzer(df)

    # 3. 执行分析
    result = analyzer.analyze()

    # 4. 提取数据
    signals = result['signals']
    stats = result['statistics']
    daily_analysis = result['daily_analysis']

    # 5. 显示基本信息
    st.write(f"分析了 {stats['total_days']} 天数据")
    st.write(f"生成了 {stats['signal_days']} 个信号")

    # 6. 显示完整UI（包括K线图标记）
    render_trading_analysis_ui(signals, df, analyzer, stats, daily_analysis)

    # 7. 自定义处理（可选）
    for signal in signals:
        if signal['type'].code == 'BUY' and signal['strength'].code == 'STRONG':
            st.success(f"强买入信号: {signal['date']} @ ¥{signal['price']:.2f}")
```

### 六、升级注意事项

#### 从旧版本升级

如果你的代码还在使用旧版本：

```python
# 旧版本（仍然可用，但建议升级）
signals, stats = analyzer.analyze()
render_trading_analysis_ui(signals, df, analyzer, stats)

# 新版本
result = analyzer.analyze()
signals = result['signals']
stats = result['statistics']
daily_analysis = result['daily_analysis']
render_trading_analysis_ui(signals, df, analyzer, stats, daily_analysis)
```

UI函数会自动适配：
- 如果没有传入 `daily_analysis`，会回退到调用 `analyzer.get_daily_analysis()`
- 保证向后兼容

### 七、版本历史

- **v1.3** (2026-01-13): 数据结构优化，返回3部分数据，新增K线图标记
- **v1.2** (2026-01-13): 枚举优化，中文显示
- **v1.1**: 无信号原因说明，预热天数优化
- **v1.0**: 初始版本，四层级分析体系

---

更多详细信息请参考：
- `docs/买卖点分析使用说明.md` - 完整使用说明
- `docs/买卖点分析-数据结构优化.md` - 技术细节
- `docs/买卖点分析-枚举优化说明.md` - 枚举系统说明
